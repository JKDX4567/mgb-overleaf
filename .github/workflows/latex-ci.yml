name: Build LaTeX PDF

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Check out
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # keep history for commit count

      - name: Compute version info
        id: ver
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          COMMIT_COUNT=$(git rev-list --count HEAD)
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT

      - name: Write version.tex (defines \VERSION)
        run: |
          echo "\\newcommand{\\VERSION}{v${{ steps.ver.outputs.commit_count }}-${{ steps.ver.outputs.short_sha }}}" > version.tex

      # Build with a maintained LaTeX action (runs inside a container)
      - name: Build PDF (itManual.tex)
        uses: xu-cheng/latex-action@v3
        with:
          root_file: itManual.tex
          # latexmk default is pdflatex; pass flags we used before:
          args: -pdf -shell-escape -file-line-error -interaction=nonstopmode
          # TeX Live packages installed via tlmgr:
          extra_packages: >-
            minted
            xcolor
            hyperref
            geometry
            etoolbox
            amsmath
            amssymb
            pgf
            listings
          # System packages inside the container (Alpine):
          # Pygments is needed for \usepackage{minted}
          extra_system_packages: >-
            python3
            py3-pip
            py3-pygments

      - name: Collect outputs
        run: |
          mkdir -p build
          cp itManual.pdf build/ || true
          ZIPNAME="itManual_v${{ steps.ver.outputs.commit_count }}-${{ steps.ver.outputs.short_sha }}.zip"
          (cd build && zip -r "$ZIPNAME" itManual.pdf)

      - name: Upload artifact (download from Actions page)
        uses: actions/upload-artifact@v4
        with:
          name: pdf-build
          path: build/

      - name: Commit PDF back to repo
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "CI: add PDF v${{ steps.ver.outputs.commit_count }}-${{ steps.ver.outputs.short_sha }}"
          file_pattern: build/*.pdf build/*.zip
          add_options: '--force'
